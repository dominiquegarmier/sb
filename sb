#!/bin/bash
set -e

# Load config if exists
CONFIG_FILE="${HOME}/.config/sb/config"
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
fi

# Parse flags, remaining args become the command
EPHEMERAL=false
FORWARD_DOCKER=false
REBUILD=false
CMD=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --rm) EPHEMERAL=true; shift ;;
        --forward-docker) FORWARD_DOCKER=true; shift ;;
        --rebuild) REBUILD=true; shift ;;
        *) CMD+=("$1"); shift ;;
    esac
done

IMAGE_NAME="sb:latest"
PROJECT_DIR="$(pwd)"
DOCKERFILE_PATH="${HOME}/.config/sb/Dockerfile"

# Use hash of absolute path for unique naming
PROJECT_HASH="$(echo -n "$PROJECT_DIR" | shasum -a 256 | cut -c1-12)"
VOLUME_NAME="sb-${PROJECT_HASH}"
CONTAINER_NAME="sb-${PROJECT_HASH}"
SYNC_NAME="sb-${PROJECT_HASH}"

# Check mutagen
if ! command -v mutagen &> /dev/null; then
    echo "Error: Mutagen is required but not installed."
    echo ""
    echo "Install with:"
    echo "  macOS:  brew install mutagen-io/mutagen/mutagen"
    echo "  Linux:  See https://mutagen.io/documentation/introduction/installation"
    exit 1
fi

# Rebuild: remove everything and start fresh
if [[ "$REBUILD" == "true" ]]; then
    echo "Rebuilding (this will delete all container state)..."
    mutagen sync terminate "$SYNC_NAME" &>/dev/null || true
    docker stop "$CONTAINER_NAME" &>/dev/null || true
    docker rm "$CONTAINER_NAME" &>/dev/null || true
    docker volume rm "$VOLUME_NAME" &>/dev/null || true
    docker rmi "$IMAGE_NAME" &>/dev/null || true
fi

# Build image if needed
if [[ -z "$(docker images -q "$IMAGE_NAME" 2>/dev/null)" ]]; then
    if [[ ! -f "$DOCKERFILE_PATH" ]]; then
        echo "Error: Dockerfile not found at $DOCKERFILE_PATH"
        echo "Run the install script again to download it."
        exit 1
    fi
    echo "Building $IMAGE_NAME (may take a few minutes)..."
    docker build -t "$IMAGE_NAME" -f "$DOCKERFILE_PATH" "$(dirname "$DOCKERFILE_PATH")"
fi

mkdir -p ~/.claude ~/.codex

# Build docker run args
DOCKER_ARGS=(
    -d
    -v "$VOLUME_NAME:/workspace"
    -v "$HOME/.claude:/root/.claude"
    -v "$HOME/.codex:/root/.codex"
    -e GH_TOKEN="${GH_TOKEN:-$GITHUB_TOKEN}"
)
if [[ "$FORWARD_DOCKER" == "true" ]]; then
    DOCKER_ARGS+=(-v /var/run/docker.sock:/var/run/docker.sock)
fi

# Cleanup on exit
cleanup() {
    echo ""
    mutagen sync terminate "$SYNC_NAME" &>/dev/null || true
    if [[ "$EPHEMERAL" == "true" ]]; then
        echo "Cleaning up..."
        docker stop "$CONTAINER_NAME" &>/dev/null || true
        docker rm "$CONTAINER_NAME" &>/dev/null || true
        docker volume rm "$VOLUME_NAME" &>/dev/null || true
    else
        echo "Detaching (container keeps running)..."
    fi
}
trap cleanup EXIT INT TERM

if [[ "$EPHEMERAL" == "true" ]]; then
    # Ephemeral mode: remove existing and create fresh
    docker stop "$CONTAINER_NAME" &>/dev/null || true
    docker rm "$CONTAINER_NAME" &>/dev/null || true
    docker volume rm "$VOLUME_NAME" &>/dev/null || true
    echo "Creating ephemeral container..."
    docker volume create "$VOLUME_NAME" &>/dev/null || true
    docker run "${DOCKER_ARGS[@]}" --name "$CONTAINER_NAME" "$IMAGE_NAME" tail -f /dev/null
else
    # Persistent mode: reuse existing container
    CONTAINER_EXISTS=$(docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$" && echo "yes" || echo "no")
    CONTAINER_RUNNING=$(docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$" && echo "yes" || echo "no")

    if [[ "$CONTAINER_RUNNING" == "yes" ]]; then
        echo "Container already running..."
    elif [[ "$CONTAINER_EXISTS" == "yes" ]]; then
        echo "Starting existing container..."
        docker start "$CONTAINER_NAME" >/dev/null
    else
        echo "Creating new container..."
        docker volume create "$VOLUME_NAME" &>/dev/null || true
        docker run "${DOCKER_ARGS[@]}" --name "$CONTAINER_NAME" "$IMAGE_NAME" tail -f /dev/null
    fi
fi

# Check if sync session exists
SYNC_EXISTS=$(mutagen sync list | grep -q "$SYNC_NAME" && echo "yes" || echo "no")

if [[ "$SYNC_EXISTS" == "yes" ]]; then
    echo "Resuming file sync..."
    mutagen sync resume "$SYNC_NAME" &>/dev/null || true
else
    echo "Starting file sync..."
    mutagen sync create \
        --name="$SYNC_NAME" \
        --sync-mode=two-way-resolved \
        --default-file-mode=0644 \
        --default-directory-mode=0755 \
        --ignore=".venv" \
        --ignore="__pycache__" \
        --ignore="*.pyc" \
        --ignore=".pytest_cache" \
        --ignore=".mypy_cache" \
        --ignore=".ruff_cache" \
        --ignore=".tox" \
        --ignore="*.egg-info" \
        --ignore=".eggs" \
        --ignore="node_modules" \
        --ignore="target" \
        --ignore="build" \
        --ignore="CMakeFiles" \
        --ignore="CMakeCache.txt" \
        --ignore="*.o" \
        --ignore="*.a" \
        --ignore="*.so" \
        --ignore="*.dylib" \
        --ignore=".cache" \
        "$PROJECT_DIR" \
        "docker://${CONTAINER_NAME}/workspace"
fi

echo "Waiting for sync..."
mutagen sync flush "$SYNC_NAME"

echo ""
if [[ ${#CMD[@]} -eq 0 ]]; then
    docker exec -it "$CONTAINER_NAME" /bin/bash
else
    docker exec -it "$CONTAINER_NAME" "${CMD[@]}"
fi
